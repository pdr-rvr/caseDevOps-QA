pipeline {
    agent any

    stage('Deploy to Staging') {
            steps {
                echo '=== Iniciando Deploy em Staging com RabbitMQ ==='
                
                dir('caseGameClass') {

                    // 1. Limpeza "bruta": Garante que containers antigos morram
                    bat 'docker stop staging-app 2>nul || exit 0'
                    bat 'docker rm staging-app 2>nul || exit 0'
                    bat 'docker stop staging-rabbitmq 2>nul || exit 0'
                    bat 'docker rm staging-rabbitmq 2>nul || exit 0'

                    // 2. Limpeza do Compose (para redes e volumes)
                    bat 'docker-compose -f docker-compose.staging.yml down -v'
                    
                    // 3. Atualização e Execução
                    bat 'docker-compose -f docker-compose.staging.yml pull'
                    bat 'docker-compose -f docker-compose.staging.yml up -d'
                    
                    echo 'Aguardando os serviços iniciarem...'
                    sleep 60 
                }
            }
        }

        stage('Health Check') {
            steps {
                echo '=== Verificando Saúde da Aplicação ==='
                // Testa se a API respondeu e conectou (Swagger UI)
                bat 'curl -f http://localhost:8686/swagger-ui/index.html || echo "Erro: Swagger inacesível"'
            }
        }
    }
}
