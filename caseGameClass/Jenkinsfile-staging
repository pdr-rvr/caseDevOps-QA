pipeline {
    agent any

    stages {
        stage('Deploy to Staging') {
            steps {
                echo '=== Iniciando Deploy em Staging com RabbitMQ ==='
                
                // Entra na pasta onde está o docker-compose.staging.yml
                dir('caseGameClass') {
                    // 1. Limpeza: Derruba containers e redes antigas
                    bat 'docker-compose -f docker-compose.staging.yml down -v'
                    
                    // 2. Atualização: Baixa a imagem mais recente da API e do RabbitMQ
                    bat 'docker-compose -f docker-compose.staging.yml pull'
                    
                    // 3. Execução: Sobe tudo (API + RabbitMQ) em background
                    bat 'docker-compose -f docker-compose.staging.yml up -d'
                    
                    echo 'Aguardando os serviços iniciarem...'
                    sleep 60 
                }
            }
        }

        stage('Health Check') {
            steps {
                echo '=== Verificando Saúde da Aplicação ==='
                // Testa se a API respondeu e conectou (Swagger UI)
                bat 'curl -f http://localhost:8686/swagger-ui/index.html || echo "Erro: Swagger inacesível"'
            }
        }
    }
}
